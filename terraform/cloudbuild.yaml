steps:
  # Step 0: Create Terraform state bucket if it doesn't exist
  - name: 'gcr.io/cloud-builders/gcloud'
    id: Create State Bucket
    entrypoint: bash
    args:
      - '-c'
      - |
        if gcloud storage buckets describe gs://${_TF_STATE_BUCKET} > /dev/null 2>&1; then
          echo "Bucket gs://${_TF_STATE_BUCKET} already exists, skipping creation"
        else
          echo "Creating bucket gs://${_TF_STATE_BUCKET}..."
          gcloud storage buckets create gs://${_TF_STATE_BUCKET} \
            --location=${_REGION} \
            --uniform-bucket-level-access || {
            echo "Warning: Could not create bucket (it may already exist)"
          }
        fi

  # Step 1: Build Terraform Docker image
  - name: 'gcr.io/cloud-builders/docker'
    id: Build Terraform Image
    args:
      - 'build'
      - '-t'
      - 'gcr.io/${PROJECT_ID}/terraform:latest'
      - '-f'
      - 'terraform/Dockerfile'
      - 'terraform'
    waitFor:
      - Create State Bucket

  # Step 2: Push Terraform image to GCR
  - name: 'gcr.io/cloud-builders/docker'
    id: Push Terraform Image
    args:
      - 'push'
      - 'gcr.io/${PROJECT_ID}/terraform:latest'
    waitFor:
      - Build Terraform Image

  # Step 3: Build App Docker image (using GCR instead of Artifact Registry)
  - name: 'gcr.io/cloud-builders/docker'
    id: Build Docker Image
    args:
      - 'build'
      - '-t'
      - 'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}:${SHORT_SHA}'
      - '-t'
      - 'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}:latest'
      - '.'
    dir: .
    waitFor:
      - Create State Bucket

  # Step 4: Push Docker image to Google Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: Push Docker Image
    args:
      - 'push'
      - '--all-tags'
      - 'gcr.io/${PROJECT_ID}/${_SERVICE_NAME}'
    waitFor:
      - Build Docker Image

  # Step 5: Deploy to Cloud Run via Terraform
  - name: gcr.io/${PROJECT_ID}/terraform
    id: Deploy Cloud Run
    entrypoint: 'bash'
    env:
      - _CHAT_WEBHOOK_URL=${_CHAT_WEBHOOK_URL}
      - _ENVIRONMENT=${_ENVIRONMENT}
      - _SERVICE_NAME=${_SERVICE_NAME}
      - _ARTIFACT_REPO=${_ARTIFACT_REPO}
      - _REGION=${_REGION}
      - REPO_NAME=${REPO_NAME}
      - REPO_FULL_NAME=${REPO_FULL_NAME}
      - BUILD_ID=${BUILD_ID}
      - PROJECT_ID=${PROJECT_ID}
      - BRANCH_NAME=${BRANCH_NAME}
      - SHORT_SHA=${SHORT_SHA}
      - LOCATION=${LOCATION}
    args:
      - '-c'
      - |
        source /workspace/terraform/scripts/utils.sh

        cd environments/${_ENVIRONMENT}
        run_or_fail terraform init -upgrade
        run_or_fail terraform apply -auto-approve \
          -var="image_tag=${SHORT_SHA}"
    dir: terraform
    waitFor:
      - Push Docker Image
      - Push Terraform Image

  # Step 6: Notify result on Google Chat
  - name: 'gcr.io/cloud-builders/curl'
    id: Notify result on GoogleChat
    entrypoint: bash
    env:
      - _CHAT_WEBHOOK_URL=${_CHAT_WEBHOOK_URL}
      - _ENVIRONMENT=${_ENVIRONMENT}
      - REPO_NAME=${REPO_NAME}
      - REPO_FULL_NAME=${REPO_FULL_NAME}
      - BUILD_ID=${BUILD_ID}
      - PROJECT_ID=${PROJECT_ID}
      - BRANCH_NAME=${BRANCH_NAME}
      - SHORT_SHA=${SHORT_SHA}
      - LOCATION=${LOCATION}
    waitFor:
      - Deploy Cloud Run
    args:
      - -c
      - |
        source /workspace/terraform/scripts/utils.sh

        notify_google_chat "SUCCESS"

# Substitution variables (can be overridden in trigger configuration)
substitutions:
  _ENVIRONMENT: staging
  _SERVICE_NAME: leadtech-crm-backend
  _ARTIFACT_REPO: leadtech-crm
  _REGION: europe-west1
  _TF_STATE_BUCKET: leadtech-crm-tf-state

# Use Cloud Logging to store the logs from the execution
options:
  logging: CLOUD_LOGGING_ONLY
